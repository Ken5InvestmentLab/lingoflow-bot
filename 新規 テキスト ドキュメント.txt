require('dotenv').config();

const { Client, GatewayIntentBits, ContextMenuCommandBuilder, ApplicationCommandType, MessageFlags, Events } = require('discord.js');
const { GoogleGenerativeAI } = require("@google/generative-ai");
const translate = require('google-translate-api-next');

const TOKEN = process.env.DISCORD_TOKEN;
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const GUILD_ID = process.env.GUILD_ID;

// ----------------

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
// å¤‰æ•°åã‚’ model ã«çµ±ä¸€
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); 

const client = new Client({ intents: [GatewayIntentBits.Guilds] });

client.once(Events.ClientReady, async (readyClient) => {
    console.log(`âœ… LingoFlow Dual Mode Ready! Logged in as ${readyClient.user.tag}`);

    const fastData = new ContextMenuCommandBuilder()
        .setName('Fast Translate')
        .setType(ApplicationCommandType.Message);

    const deepData = new ContextMenuCommandBuilder()
        .setName('Deep Translate')
        .setType(ApplicationCommandType.Message);

    const guild = client.guilds.cache.get(GUILD_ID);
    if (guild) {
        await guild.commands.set([fastData, deepData]);
        console.log('âœ… Two commands registered successfully!');
    }
});

client.on(Events.InteractionCreate, async interaction => {
    if (!interaction.isMessageContextMenuCommand()) return;

    const originalText = interaction.targetMessage.content;
    const targetLang = interaction.locale.split('-')[0];

    if (!originalText) {
        return interaction.reply({ content: 'ç¿»è¨³ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚', flags: [MessageFlags.Ephemeral] });
    }

    await interaction.deferReply({ flags: [MessageFlags.Ephemeral] });

    // --- Fast Translate (Google) ---
    if (interaction.commandName === 'Fast Translate') {
        try {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ç¿»è¨³
            const res = await translate(originalText, { to: targetLang });
            await interaction.editReply({
                content: `âš¡ **Fast Translate (Google):**\n${res.text}`
            });
        } catch (error) {
            console.error(error);
            await interaction.editReply('Fast Translateã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    }

    // --- Deep Translate (Gemini) ---
    if (interaction.commandName === 'Deep Translate') {
        try {
            const prompt = `Translate the following text into the language of code "${targetLang}". 
            Context: Online chat. Deliver only the translated text.
            Text: ${originalText}`;

            // å¤‰æ•°åã‚’ model ã«ä¿®æ­£
            const result = await model.generateContent(prompt);
            const translatedText = result.response.text();

            await interaction.editReply({
                content: `ğŸ§  **Deep Translate (Gemini):**\n${translatedText}`
            });
        } catch (error) {
            console.error(error);
            await interaction.editReply('Deep Translateã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    }
});

client.login(TOKEN);